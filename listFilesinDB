require("./access.js");
const { MongoClient, ServerApiVersion } = require('mongodb');
const fs = require("fs");
const uri = database_key;
const client = new MongoClient(uri, { useNewUrlParser: true, useUnifiedTopology: true, serverApi: ServerApiVersion.v1 });

async function listFilesinDB(jsonFile) {
  let fileData;
  let jsonFiles = [];
  let totalSameFiles = 0;
  try {
    await client.connect();
    const db = client.db('file_data');
    fileData = fs.readFileSync(jsonFile, 'utf8');
    jsonFiles = JSON.parse(fileData).map(file => file.fileName);
    const collections = await db.listCollections().toArray();
    const collectionNames = collections.map(collection => collection.name);
    let filenames = [];
    const countPerCollection = {};

    for (const collectionName of collectionNames) {
      filenames = [];
      const collection = db.collection(collectionName);
      const count = await collection.countDocuments();
      countPerCollection[collectionName] = count;

      // Create a change stream to stream updates in real-time
      const changeStream = collection.watch();
      changeStream.on("change", (change) => {
        if (change.operationType === "insert") {
          filenames.push(change.fullDocument.fileName);
          const sameFilesInCollection = filenames.filter(file => jsonFiles.includes(file)).length;
          totalSameFiles += sameFilesInCollection;
          console.log(`Same files as in json in ${collectionName}: ${sameFilesInCollection}`);
        }
      });
    }
    console.log("Files count per collection: ", countPerCollection);
  } catch (error) {
    console.error(error);
  } finally {
    if (client) {
    }
  }
}

listFilesinDB('D:\\output\\results.json').catch(error => console.error(error));
