require("./access.js");
const fs = require('fs');
const { Transform } = require('stream');
const MongoClient = require('mongodb').MongoClient;
const JSONStream = require('jsonstream');

async function storeFilesInDb(filePath) {
  let client;
  try {
    client = new MongoClient(database_key, { useUnifiedTopology: true });
    await client.connect();

    const db = client.db("file_data");
    const writeStream = new Transform({
      objectMode: true,
      async transform(file, encoding, callback) {
        const collection = db.collection(file.folder);
        const existingFile = await collection.findOne({ fileName: file.fileName });
        if (!existingFile) {
          await collection.insertOne({ fileName: file.fileName });
        }
        console.log(`files stored! folder:${file.folder}, filename:${file.fileName}`);
        console.log(`Total files stored: ${await collection.countDocuments()}`)
        callback();
      },
    });

    fs.createReadStream(filePath, { encoding: 'utf8' })
      .pipe(JSONStream.parse('*'))
      .pipe(writeStream);

  } catch (error) {
    console.error(error);
  } finally {
    if (client) {
      //await client.close();
    }
  }
}

storeFilesInDb('D:\\output\\results.json');